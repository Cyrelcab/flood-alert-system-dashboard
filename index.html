<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="../assets/img/apple-icon.png"
    />
    <link rel="icon" type="image/png" href="../assets/img/logo.png" />
    <title>Lemon - Flood Alert System</title>
    <!--     Fonts and icons     -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
      rel="stylesheet"
    />
    <!-- Font Awesome Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- CSS Files -->
    <link
      id="pagestyle"
      href="../assets/css/argon-dashboard.css?v=2.1.0"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body class="g-sidenav-show bg-gray-100">
    <div
      class="min-height-300 position-absolute w-100 bg-primary"
    ></div>
    <aside
      class="sidenav bg-white navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-4"
      id="sidenav-main"
    >
      <div class="sidenav-header">
        <i
          class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
          aria-hidden="true"
          id="iconSidenav"
        ></i>
        <a
          class="navbar-brand m-0 d-flex align-items-center justify-content-center"
          href="./index.html"
        >
          <img
            src="./assets/img/logo.png"
            alt=""
            width="30"
            height="30"
            class="me-2"
          />
          <span class="font-weight-bold">Lemon - Flood Alert System</span>
        </a>
      </div>
      <hr class="horizontal dark mt-0" />
      <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" href="./index.html">
              <div
                class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center"
              >
                <i class="fa fa-tachometer text-dark text-sm opacity-10"></i>
              </div>
              <span class="nav-link-text ms-1">Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../pages/data-logs.html">
              <div
                class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center"
              >
                <i class="fa fa-table text-dark text-sm opacity-10"></i>
              </div>
              <span class="nav-link-text ms-1">Data Logs</span>
            </a>
          </li>
        </ul>
      </div>
    </aside>
    <main class="main-content position-relative border-radius-lg">
      <!-- Navbar -->
      <nav
        class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl"
        id="navbarBlur"
        data-scroll="false"
      >
        <div class="container-fluid py-1 px-3">
          <nav aria-label="breadcrumb">
            <ol
              class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5"
            >
              <li class="breadcrumb-item text-sm">
                <a class="opacity-5 text-white" href="javascript:;">Pages</a>
              </li>
              <li
                class="breadcrumb-item text-sm text-white active"
                aria-current="page"
              >
                Dashboard
              </li>
            </ol>
            <h6 class="font-weight-bolder text-white mb-0">Dashboard</h6>
          </nav>
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
            <div class="text-white d-flex flex-column align-items-end">
              <span
                id="clock"
                class="font-weight-bolder"
                style="font-size: 1.5rem"
              ></span>
              <span
                id="date"
                class="font-weight-bolder"
                style="font-size: 0.9rem"
              ></span>
            </div>
            <script src="../assets/js/clock.js"></script>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->
      <div class="container-fluid py-4">
        <div class="row">
          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4 me-3">
            <div class="card">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-8">
                    <div class="numbers">
                      <p class="text-sm mb-0 text-uppercase font-weight-bold">
                        Flow Rate (L/s)
                      </p>
                      <h5 class="font-weight-bolder mt-3">
                        Sensor 1: <span id="flow-rate-sensor-1">0</span>
                      </h5>
                      <h5 class="font-weight-bolder">
                        Sensor 2: <span id="flow-rate-sensor-2">0</span>
                      </h5>
                    </div>
                  </div>
                  <div class="col-4 text-end">
                    <div
                      class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle"
                    >
                      <div
                        class="d-flex justify-content-center align-items-center h-100"
                      >
                        <img
                          src="../assets/img/water-meter-icon.png"
                          alt="Flow Rate"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4 me-3">
            <div class="card">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-8">
                    <div class="numbers">
                      <p class="text-sm mb-0 text-uppercase font-weight-bold">
                        Humidity (%)
                      </p>
                      <h5 class="font-weight-bolder mt-3">
                        Sensor 1: <span id="humidity-sensor-1">0</span>
                      </h5>
                      <h5 class="font-weight-bolder">
                        Sensor 2: <span id="humidity-sensor-2">0</span>
                      </h5>
                    </div>
                  </div>
                  <div class="col-4 text-end">
                    <div
                      class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle"
                    >
                      <div
                        class="d-flex justify-content-center align-items-center h-100"
                      >
                        <img
                          src="../assets/img/humidity-icon.png"
                          alt="Humidity"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-8">
                    <div class="numbers">
                      <p
                        class="text-sm mb-0 text-uppercase font-weight-bold text-nowrap"
                      >
                        Distance to Water Surface (cm)
                      </p>
                      <h5 class="font-weight-bolder mt-3">
                        Sensor 1: <span id="water-level-sensor-1">0</span>
                      </h5>
                      <h5 class="font-weight-bolder">
                        Sensor 2: <span id="water-level-sensor-2">0</span>
                      </h5>
                    </div>
                  </div>
                  <div class="col-4 text-end">
                    <div
                      class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle"
                    >
                      <div
                        class="d-flex justify-content-center align-items-center h-100"
                      >
                        <img
                          src="../assets/img/water-level-icon.png"
                          alt="Water Level"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row mt-6">
          <!-- Water Surface Monitoring Chart -->
          <div class="col-lg-7 mb-lg-0 mb-4">
            <div class="card z-index-2 h-100">
              <div class="card-header pb-0 pt-3 bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="text-capitalize">
                      Real-time Water Surface Monitoring
                    </h6>
                    <p class="mb-0 text-sm" id="chart-time-range"></p>
                  </div>
                  <div class="d-flex align-items-center">
                    <label for="date-filter" class="me-2"
                      >Filter by Date:</label
                    >
                    <input
                      type="date"
                      id="date-filter"
                      class="form-control w-auto"
                      onchange="filterChartByDate(this.value)"
                    />
                  </div>
                </div>
              </div>
              <div class="card-body p-3">
                <div class="chart">
                  <canvas
                    id="chart-line"
                    class="chart-canvas"
                    height="400"
                  ></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Gauges Row -->
          <div class="col-lg-5 mb-lg-0 mb-4">
            <div class="row">
              <!-- Flood Risk Gauge -->
              <div class="col-12 mb-4">
                <div class="card">
                  <div class="card-header pb-0 p-3">
                    <h6 class="mb-0">Flood Risk Gauge</h6>
                  </div>
                  <div class="card-body p-3">
                    <canvas
                      id="flood-risk-gauge"
                      style="height: 200px"
                    ></canvas>
                  </div>
                </div>
              </div>

              <!-- Flow Risk Gauge -->
              <div class="col-12">
                <div class="card">
                  <div class="card-header pb-0 p-3">
                    <h6 class="mb-0">Flow Risk Gauge</h6>
                  </div>
                  <div class="card-body p-3">
                    <canvas id="flow-risk-gauge" style="height: 200px"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Map Section -->
          <div class="col-12 mt-4">
            <div class="card">
              <div class="card-header pb-0 p-3">
                <h6 class="mb-0">Barangay Lemon Map</h6>
              </div>
              <div class="card-body p-3">
                <div class="map-container" style="height: 500px">
                  <div id="map" style="width: 100%; height: 100%"></div>
                </div>

                <!-- Leaflet CSS and JS -->
                <link
                  rel="stylesheet"
                  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
                />
                <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
                <!-- Font Awesome for pin icons -->
                <link
                  rel="stylesheet"
                  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Core JS Files -->
    <script src="../assets/js/core/popper.min.js"></script>
    <script src="../assets/js/core/bootstrap.min.js"></script>
    <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
    <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
    <script src="../assets/js/plugins/chartjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Main Application Script -->
    <script>
      // Global variables
      let waterLevelChart = null;
      let realtimeChannel = null;
      let supabase = null;
      let lastFilteredDate = null;
      let currentChartData = []; // Store current chart data for real-time updates

      document.addEventListener("DOMContentLoaded", function () {
        // Initialize Supabase client
        const SUPABASE_URL = "https://tsiiblalobzwtzcxuzck.supabase.co";
        const SUPABASE_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzaWlibGFsb2J6d3R6Y3h1emNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE4NzM5OTcsImV4cCI6MjA1NzQ0OTk5N30.6s_K1YnMeHu0rimrfDMG7KFQ9Q-KoQ72W6Tzciz0f1w";
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Set the default date in the date filter
        const dateFilter = document.getElementById("date-filter");
        if (dateFilter) {
          dateFilter.value = getCurrentDate(); // Use the function from clock.js
        }

        // Initialize everything
        initializeDashboard();
        initializeMap();

        // Set up real-time updates
        setupRealtimeUpdates();
      });

      // Function to update dashboard cards
      async function updateDashboardCards() {
        try {
          const { data, error } = await supabase
            .from("sensor_data")
            .select("*")
            .order("created_at", { ascending: false })
            .limit(1);

          if (error) throw error;

          if (data && data.length > 0) {
            const sensorData = data[0];
            console.log("Latest sensor data:", sensorData);

            // Update Flow Rate card
            document.getElementById("flow-rate-sensor-1").textContent = `${
              sensorData.flow_rate_1 || 0
            } L/s`;
            document.getElementById("flow-rate-sensor-2").textContent = `${
              sensorData.flow_rate_2 || 0
            } L/s`;

            // Update Humidity card
            document.getElementById("humidity-sensor-1").textContent = `${
              sensorData.humidity_1 || 0
            }%`;
            document.getElementById("humidity-sensor-2").textContent = `${
              sensorData.humidity_2 || 0
            }%`;

            // Update Water Level card
            document.getElementById("water-level-sensor-1").textContent = `${
              sensorData.water_level_1 || 0
            } cm`;
            document.getElementById("water-level-sensor-2").textContent = `${
              sensorData.water_level_2 || 0
            } cm`;

            // Determine thresholds for water levels
            const waterLevel1 = sensorData.water_level_1 || 0;
            const waterLevel2 = sensorData.water_level_2 || 0;

            // Update the flood risk gauge
            updateFloodRiskGauge(Math.max(waterLevel1, waterLevel2)); // Use the highest water level for the gauge

            // Update the background color based on flood risk
            updateBackgroundColor(Math.max(waterLevel1, waterLevel2));
          }
        } catch (err) {
          console.error("Error updating dashboard:", err);
        }
      }

      // Function to format timestamp with added 16 hours and convert to 12-hour format
      function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        date.setHours(date.getHours() + 16); // Add 16 hours

        // Format as HH:MM AM/PM (12-hour format)
        return date.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true, // Use 12-hour format
          timeZone: "Asia/Manila", // Ensure it matches the desired timezone
        });
      }

      // Function to filter chart by date
      async function filterChartByDate(selectedDate) {
        try {
          if (!selectedDate || selectedDate === lastFilteredDate) {
            return; // Skip if no date is selected or the date hasn't changed
          }

          lastFilteredDate = selectedDate; // Update the last filtered date
          console.log(`Filtering chart for date: ${selectedDate}`);

          // Determine the date range
          const startOfDay = `${selectedDate}T00:00:00`;
          const endOfDay = `${selectedDate}T23:59:59`;

          // Fetch data for the selected date
          const { data, error } = await supabase
            .from("sensor_data")
            .select("created_at, water_level_1, water_level_2")
            .gte("created_at", startOfDay)
            .lte("created_at", endOfDay)
            .order("created_at", { ascending: true });

          if (error) throw error;

          if (!data || data.length === 0) {
            console.log("No data available for the selected date");
            document.getElementById(
              "chart-time-range"
            ).textContent = `No data available for ${new Date(
              selectedDate
            ).toLocaleDateString("en-US", {
              month: "long",
              day: "numeric",
              year: "numeric",
            })}`;
            if (waterLevelChart) waterLevelChart.destroy();
            currentChartData = [];
            return;
          }

          // Store the current data for real-time updates
          currentChartData = data;

          // Update the chart with filtered data
          updateChartWithData(data, selectedDate);
        } catch (err) {
          console.error("Error filtering chart:", err);
        }
      }

      // Function to update chart with data
      function updateChartWithData(chartData, dateLabel) {
        const labels = chartData.map((record) =>
          formatTimestamp(record.created_at)
        ); // Use updated formatTimestamp

        // Prepend a starting point of 0 to the data and labels
        labels.unshift("Start");
        const sensor1Data = [0, ...chartData.map((d) => d.water_level_1)];
        const sensor2Data = [0, ...chartData.map((d) => d.water_level_2)];

        const ctx = document.getElementById("chart-line").getContext("2d");

        // Destroy previous chart if exists
        if (waterLevelChart) {
          waterLevelChart.destroy();
        }

        // Create new chart
        waterLevelChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels, // Use formatted timestamps as labels
            datasets: [
              {
                label: "Sensor 1",
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 2,
                borderColor: "#5e72e4",
                fill: false,
                data: sensor1Data, // Use modified data with starting point
              },
              {
                label: "Sensor 2",
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 2,
                borderColor: "#2dce89",
                fill: false,
                data: sensor2Data, // Use modified data with starting point
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  title: function (context) {
                    // Display the timestamp in the tooltip with added 16 hours
                    const dataPoint = chartData[context[0].dataIndex - 1];
                    return context[0].dataIndex === 0
                      ? "Start"
                      : formatTimestamp(dataPoint.created_at);
                  },
                  label: function (context) {
                    return `${
                      context.dataset.label
                    }: ${context.parsed.y.toFixed(2)} cm`;
                  },
                },
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Time",
                },
              },
              y: {
                title: {
                  display: true,
                  text: "Distance to Water Surface (cm)",
                },
                reverse: true, // Invert the y-axis
                ticks: {
                  callback: function (value) {
                    return value + " cm"; // Add unit to y-axis labels
                  },
                },
              },
            },
          },
        });
      }

      // Initialize everything
      async function initializeDashboard() {
        try {
          await updateDashboardCards();

          // Set the default date without triggering the onchange event
          const dateFilter = document.getElementById("date-filter");
          if (dateFilter) {
            const today = getCurrentDate(); // Use the function from clock.js
            dateFilter.value = today; // Set the default date
            await filterChartByDate(today); // Explicitly call the filter function
          }

          setupRealtimeUpdates();
        } catch (err) {
          console.error("Initialization error:", err);
        }
      }

      // Setup real-time updates for sensor data and sensor status
      function setupRealtimeUpdates() {
        // Remove existing channels if they exist
        if (realtimeChannel) {
          supabase.removeChannel(realtimeChannel);
        }

        // Real-time updates for sensor data
        realtimeChannel = supabase
          .channel("sensor-updates")
          .on(
            "postgres_changes",
            {
              event: "INSERT",
              schema: "public",
              table: "sensor_data",
            },
            async (payload) => {
              console.log("New sensor data inserted:", payload.new);

              // Update dashboard cards immediately
              await updateDashboardCards();

              // Get current filter date
              const selectedDate = document.getElementById("date-filter").value;
              const newDataDate = new Date(payload.new.created_at)
                .toISOString()
                .split("T")[0];

              // Check if new data matches the current filter date
              if (selectedDate === newDataDate) {
                // Add new data to current chart data
                currentChartData.push({
                  created_at: payload.new.created_at,
                  water_level_1: payload.new.water_level_1,
                  water_level_2: payload.new.water_level_2,
                });

                // Update the chart with the new data
                updateChartWithData(currentChartData, selectedDate);
              }
            }
          )
          .subscribe();

        // Real-time updates for sensor status
        supabase
          .channel("sensor-status-updates")
          .on(
            "postgres_changes",
            {
              event: "UPDATE",
              schema: "public",
              table: "sensor_status",
            },
            (payload) => {
              console.log("Sensor status updated:", payload.new);

              // Update markers based on real-time status
              updateMarker(sensor1Marker, "Sensor 1", payload.new.sensor1);
              updateMarker(sensor2Marker, "Sensor 2", payload.new.sensor2);
            }
          )
          .subscribe();
      }

      // Sidebar scrollbar initialization
      var win = navigator.platform.indexOf("Win") > -1;
      if (win && document.querySelector("#sidenav-scrollbar")) {
        var options = {
          damping: "0.5",
        };
        Scrollbar.init(document.querySelector("#sidenav-scrollbar"), options);
      }
    </script>
    <script>
      // Custom plugin to draw the needle
      const gaugeNeedlePlugin = {
        id: "gaugeNeedle",
        afterDatasetDraw(chart, args, options) {
          // Check if the chart is the Flood Risk Gauge
          if (chart.canvas.id !== "flood-risk-gauge") {
            return; // Skip execution for other charts
          }

          const { ctx, chartArea } = chart;
          const needleValue = options.needleValue || 0; // Default to 0 if undefined
          const dataTotal = chart.data.datasets[0].data.reduce(
            (a, b) => a + b,
            0
          );
          const angle = Math.PI + (1 / dataTotal) * needleValue * Math.PI;

          const needleRadius = (chartArea.width / 2) * 0.40; // Adjust the needle length
          const needleCenterX = (chartArea.left + chartArea.right) / 2;
          const needleCenterY = chartArea.bottom;

          // Draw the needle
          ctx.save();
          ctx.translate(needleCenterX, needleCenterY);
          ctx.rotate(angle);
          ctx.beginPath();
          ctx.moveTo(0, -5);
          ctx.lineTo(needleRadius, 0);
          ctx.lineTo(0, 5);
          ctx.fillStyle = "black";
          ctx.fill();
          ctx.restore();

          // Draw the needle center
          ctx.beginPath();
          ctx.arc(needleCenterX, needleCenterY, 10, 0, Math.PI * 2);
          ctx.fillStyle = "black";
          ctx.fill();
          ctx.restore();
        },
      };

      // Register the plugin globally
      Chart.register(gaugeNeedlePlugin);

      // Initialize the Flood Risk Gauge
      const ctx = document.getElementById("flood-risk-gauge").getContext("2d");

      const floodRiskGauge = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Normal", "Alert", "Critical"], // Labels for the legend
          datasets: [
            {
              data: [33.33, 33.33, 33.33], // Equal segments for each risk level
              backgroundColor: ["#28a745", "#ffc107", "#dc3545"], // Colors for Low, High, Critical
              borderWidth: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "70%", // Creates the gauge effect
          rotation: -90, // Start from the bottom
          circumference: 180, // Half-circle
          plugins: {
            legend: {
              display: true, // Enable the legend
              position: "bottom", // Position the legend below the chart
              labels: {
                font: {
                  size: 14, // Font size for legend labels
                },
                color: "#333", // Font color for legend labels
                padding: 23, // Padding between legend items
              },
            },
            tooltip: {
              enabled: false, // Disable tooltips
            },
            gaugeNeedle: {
              needleValue: 0, // Initial needle value
            },
          },
        },
      });

      // Function to update the gauge dynamically
      function updateFloodRiskGauge(waterLevel) {
        let needleValue;

        // Determine needle value based on water level conditions
        if (waterLevel >= 60) {
          // Low risk - Green
          needleValue = 16.665; // Middle of first third
        } else if (waterLevel <= 59 && waterLevel >= 0) {
          // High risk - Yellow
          needleValue = 49.995; // Middle of second third
        } else if (waterLevel < 0) {
          // Critical risk - Red
          needleValue = 83.325; // Middle of last third
        }

        console.log("Updating needle value to:", needleValue);

        // Check if the gaugeNeedle plugin exists
        if (floodRiskGauge.options.plugins.gaugeNeedle) {
          // Update the needle value
          floodRiskGauge.options.plugins.gaugeNeedle.needleValue = needleValue;

          // Update the chart
          floodRiskGauge.update();
        } else {
          console.error(
            "gaugeNeedle plugin is not defined in the chart options."
          );
        }
      }
    </script>

    <!-- Script for the Flow Risk Gauge -->
    <script>
      // Custom plugin to draw the needle for flow risk gauge
      const flowGaugeNeedlePlugin = {
      id: "flowGaugeNeedle",
      afterDatasetDraw(chart, args, options) {
        if (chart.canvas.id !== "flow-risk-gauge") {
        return; // Only run for flow risk gauge
        }

        const { ctx, chartArea } = chart;
        const needleValue = options.needleValue || 0;
        const dataTotal = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
        const angle = Math.PI + (1 / dataTotal) * needleValue * Math.PI;

        const needleRadius = (chartArea.width / 2) * 0.40;
        const centerX = (chartArea.left + chartArea.right) / 2;
        const centerY = chartArea.bottom;

        // Draw needle
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(angle);
        ctx.beginPath();
        ctx.moveTo(0, -5);
        ctx.lineTo(needleRadius, 0);
        ctx.lineTo(0, 5);
        ctx.fillStyle = "black";
        ctx.fill();
        ctx.restore();

        // Draw center point
        ctx.beginPath();
        ctx.arc(centerX, centerY, 10, 0, Math.PI * 2);
        ctx.fillStyle = "black";
        ctx.fill();
      }
      };

      Chart.register(flowGaugeNeedlePlugin);

      // Initialize flow risk gauge
      const flowCtx = document.getElementById("flow-risk-gauge").getContext("2d");
      const flowRiskGauge = new Chart(flowCtx, {
      type: "doughnut",
      data: {
        labels: ["Normal Flow", "Alert Flow", "High Flow"],
        datasets: [{
        data: [33.33, 33.33, 33.33],
        backgroundColor: ["#28a745", "#ffc107", "#dc3545"], // Green, Yellow, Red
        borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "70%",
        rotation: -90,
        circumference: 180,
        plugins: {
        legend: {
          display: true,
          position: "bottom",
          labels: {
          font: { size: 14 },
          color: "#333",
          padding: 23
          }
        },
        tooltip: {
          enabled: false
        },
        flowGaugeNeedle: {
          needleValue: 0
        }
        }
      }
      });

      // Function to update flow risk gauge
      function updateFlowRiskGauge(flowRate) {
      let needleValue;

      // Determine needle position based on flow rate
      if (flowRate < 2) { // Low flow
        needleValue = 16.665;
      } else if (flowRate >= 2 && flowRate <= 5) { // Normal flow
        needleValue = 49.995;
      } else { // High flow
        needleValue = 83.325;
      }

      // Update gauge
      if (flowRiskGauge.options.plugins.flowGaugeNeedle) {
        flowRiskGauge.options.plugins.flowGaugeNeedle.needleValue = needleValue;
        flowRiskGauge.update();
      }
      }
    </script>

    <!-- Script for the map -->
    <script>
      // Global variables for markers
      let sensor1Marker = null;
      let sensor2Marker = null;
      let map = null;

      // Function to initialize the map
      function initializeMap() {
        // Initialize the map
        map = L.map("map").setView([8.938112, 125.591943], 18);

        // Add OpenStreetMap tiles
        L.tileLayer(
          "https://api.maptiler.com/maps/satellite/{z}/{x}/{y}@2x.jpg?key=MelpifBWqYE9JvjRYide",
          {
            tileSize: 512,
            zoomOffset: -1,
            minZoom: 15, // Set minimum zoom level
            maxZoom: 22, // Set maximum zoom level
            zoom: 18, // Set initial zoom level
            attribution:
              '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
          }
        ).addTo(map);

        // Add initial markers (gray by default)
        sensor1Marker = createMarker([8.937806, 125.592646], "Sensor 1", false);
        sensor2Marker = createMarker([8.939019, 125.591598], "Sensor 2", false);

        // Force popups to stay open
        sensor1Marker.openPopup();
        sensor2Marker.openPopup();

        // Set up real-time subscription for sensor status
        setupSensorStatusSubscription();
      }

      // Function to create a marker with status-based color
      function createMarker(location, name, isActive) {
        const pinColor = isActive ? "#32CD32" : "#dc3545"; // Light green for active, red for inactive

        const customIcon = L.divIcon({
          html: `<i class="fas fa-map-marker-alt" style="color: ${pinColor}; font-size: 32px;"></i>`,
          className: "custom-pin",
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -32],
        });

        const marker = L.marker(location, {
          icon: customIcon,
        }).addTo(map);

        const popup = L.popup({
          closeButton: false,
          autoClose: false,
          closeOnClick: false,
        }).setContent(
          `<b>${name}</b><br>Status: ${isActive ? "Active" : "Inactive"}`
        );

        marker.bindPopup(popup).openPopup();
        return marker;
      }

      // Function to update a specific marker
      function updateMarker(marker, name, isActive) {
        const pinColor = isActive ? "#32CD32" : "#dc3545";

        const newIcon = L.divIcon({
          html: `<i class="fas fa-map-marker-alt" style="color: ${pinColor}; font-size: 32px;"></i>`,
          className: "custom-pin",
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -32],
        });

        marker.setIcon(newIcon);

        const popup = L.popup({
          closeButton: false,
          autoClose: false,
          closeOnClick: false,
        }).setContent(
          `<b>${name}</b><br>Status: ${isActive ? "Active" : "Inactive"}`
        );

        marker.bindPopup(popup).openPopup();
      }

      // Function to setup real-time subscription for sensor status
      function setupSensorStatusSubscription() {
        const channel = supabase
          .channel("sensor-status")
          .on(
            "postgres_changes",
            {
              event: "*",
              schema: "public",
              table: "sensor_status",
            },
            (payload) => {
              if (payload.new) {
                // Update markers based on real-time status
                updateMarker(sensor1Marker, "Sensor 1", payload.new.sensor1);
                updateMarker(sensor2Marker, "Sensor 2", payload.new.sensor2);
              }
            }
          )
          .subscribe();
      }

      // Initial status check
      async function checkInitialStatus() {
        try {
          const { data, error } = await supabase
            .from("sensor_status")
            .select("*")
            .limit(1);

          if (error) throw error;

          if (data && data.length > 0) {
            updateMarker(sensor1Marker, "Sensor 1", data[0].sensor1);
            updateMarker(sensor2Marker, "Sensor 2", data[0].sensor2);
          }
        } catch (err) {
          console.error("Error checking initial status:", err);
        }
      }

      // When document is ready, check initial status
      document.addEventListener("DOMContentLoaded", () => {
        checkInitialStatus();
      });
    </script>
  </body>
</html>
